<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Alertify sakit sa ulo -->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"/>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css"/>
    <!-- Sweet -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="icon" type="image/x-icon" href="img/logo.ico">

    <style>
          .navbar {
            background-color: #008000; 
            transition: background-color 0.3s ease; 
          }
         
          .nav-link {
            color: white;
            font-weight: 500;
            transition: color 0.3s ease 
          }
          .nav-link.scrolled:hover {
            color: #006341; 
            font-weight: 500;
          }
         
          .login__bg{
            position: absolute;
            width: 100%;
            height: 110%;
            object-fit: cover;
            object-position: center;
            z-index: -1;
          }
          .login_card{
            height: 90%;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.385); 
            backdrop-filter: blur(10px); 
            box-shadow: rgba(0, 0, 0, 0.3) 0px 19px 38px, rgba(0, 0, 0, 0.22) 0px 15px 12px;
          }
         
    </style>
</head>
<body>
    <!--Navbar-->
    <nav class="navbar navbar-expand-lg shadow-lg sticky-top" id="navbar">
      <div class="container-sm d-flex justify-content-between" style="width: 100%">

        <div class="d-flex justify-content-between align-items-center" style="width: 100vw">
          <div class="d-flex align-items-center">
            <!-- Logo and text -->
            <div>
                <img src="img/logo.png" alt="" style="width: 60px;" />
            </div>
            <div class="ms-2">
                <h3 class="fw-bold m-0">Library Users Registration</h3>
            </div>
          </div>
          <div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent">
              <i class="fa-solid fa-bars" id="mugIcon"></i>
            </button>
          </div>
        </div>
        <div class="collapse navbar-collapse container-fluid" id="navbarSupportedContent" style="width: 30vw">
          <ul class="navbar-nav mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link " aria-current="page" href="home.html">
                Home
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link " href="cart.html">
                Cart(<span id="cartCount">0</span>)
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link " href="index.html">
                Logout <i class="fa-solid fa-power-off"></i>
              </a>
            </li>
          </ul>
        </div>
    
      </div>
    </nav>
    <!--End ti Navbar -->



      <!-- MODAL -->

      <div id="modalContainer"></div>

      <!-- END MODAL -->

      <!--Hero-->
     <section class="container-sm">
        <div class="d-flex flex-column align-items-center text-center">
          <img
            src="./img/lms.jpg"
            style="width: 200px; height: 200px"
            alt=""
            class="mt-5 mb-3 img-fluid"
            srcset=""
          />
          <p class="w-75 lead text-secondary fst-italic">
            Starbucks is more than just a coffee shop; it's a community hub where
            people connect over delicious drinks and meaningful moments. With our
            expertly crafted coffees, teas, and snacks, every visit is an
            opportunity to treat yourself to quality and comfort. From our iconic
            lattes to seasonal favorites, there's something for every palate. Join
            us at Starbucks and let's make every sip count.
          </p>
          <!-- <a class="nav-link" data-bs-toggle="modal" data-bs-target="#addProduct"> 
          <button class="btn btn-outline-success" >Add Product</button>
          </a> -->
        </div>
      </section>
      <!-- End Hero-->
  
      <hr class="container-sm Sborder border-success mt-5 border-2 opacity-50" />
  
      <!--Cart-->
    <section class="container-sm mt-5">
        <h5  id="customerID"></h5>
        <h2>Your Cart: <b id="totalItems"></b> items</h2>
        <span id="cartStatus" class="lead badge text-bg-danger">
          Please select a book</span
        >
  
        <table class="table">
          <thead>
            <tr>
              <th>Book Title</th>
              <th>Book Author</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="cartTableBody"></tbody>
        </table>
        <div class="row">
          <div class="col-md-6 px-4">
             
          </div>
          <div class="col-md-6 text-end">
              <button class="btn btn-outline-dark" id="borrowButton">Borrow Book</button>
          </div>
        
      </div>
      </section>
      <!---end Cart-->
    
      <!---Footer-->
      <footer class="mt-5 text-white p-3" style="background-color: #008000;">
        <div class="container-sm d-flex justify-content-between align-items-center">
          <div class="">
            <h4>ISPSC Library Management System</h4>
            <h5>CCSIT 210</h5>
            <ul>
              <li>Dran Leynard Gamoso</li>
              <li>Dran Leynard Gamoso</li>
            </ul>
          </div>
          <div class="">
            <div>
              <img src="./img/logo.png" style=" width: 50px; height: 50px;" alt="">
            </div>
            <div>
              <p class="fst-bold">&copy DL Visuals</p>
            </div>
          </div>
        </div>
      </footer>
     <!---End Footer-->

 
     <script type="text/javascript">
      alertify.set('notifier', 'position', 'top-right');

      $(document).ready(function () {
        $('#modalContainer').load('modal.html');
      });
    
     
        document.addEventListener("DOMContentLoaded", function() {
            var studentID = sessionStorage.getItem('studentID');
            var studentName = sessionStorage.getItem('studentName');
            var bookItems = JSON.parse(localStorage.getItem("bookItems")) || [];
            // Check if customerID is present
            if (customerID) {
            document.getElementById('studentID').innerText = 'Student Name: ' + customerName;
            console.log('Customer ID ' + studentID)
            console.log('Customer Name ' + studentName);
            console.log(cartItems)
            
            } else {
                console.log('Customer ID not found in sessionStorage'); 
            }
        });
   

        document.addEventListener("DOMContentLoaded", function () {
            const displayCartItems = () => {
                var cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
        
                var cartTableBody = document.getElementById("cartTableBody");
                var cartStatus = document.getElementById("cartStatus");
                var totalItemsElement = document.getElementById("totalItems"); // Updated variable name
        
                cartTableBody.innerHTML = "";
                var totalItems = 0; // Initialize totalItems variable
        
                // Iterate through each cart item and append to the table
                cartItems.forEach(function (item, index) {
                    var row = "<tr>" +
                        "<td>" + item.title + "</td>" +
                        "<td>" + item.author + "</td>" +
                        "<td><button class='btn btn-outline-danger cancel-btn' onclick='cancelItem(" + index + ")'>Cancel</button></td>" +
                        "</tr>";
        
                    // Append the row to the table body
                    cartTableBody.innerHTML += row;
        
                    // Increment totalItems for each item in the cart
                    totalItems++;
                });
        
                // Update the totalItems element with the total count
                totalItemsElement.innerText = totalItems; // Update the innerText property
        
                if (cartItems.length === 0) {
                    cartStatus.style.display = "block";
                } else {
                    cartStatus.style.display = "none";
                }
            };
        
            // Call the displayCartItems function when the page loads
            displayCartItems();
        });
        



        //Cancel function on my cart
        function cancelItem(index) {

            //  alertify.success('Item canceled successfully!');
            Swal.fire({
              icon: 'success',
              title: 'Item canceled successfully!',
              showConfirmButton: false,
              timer: 1500 // Adjust the duration as needed
            });
            

              // Retrieve the cart items from localStorage
              var cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];

              setTimeout(function () {
                          location.reload();
              }, 1000);

              // Check if the index is valid
              if (index >= 0 && index < cartItems.length) {
                  // Update the cart count by subtracting the quantity of the canceled item
                  var canceledItemQuantity = cartItems[index].quantity;
                  var totalCount = parseInt(localStorage.getItem("cartCount")) || 0;
                  totalCount -= canceledItemQuantity;
                  localStorage.setItem("cartCount", totalCount);
          
                  // Remove the item at the specified index from the array
                  cartItems.splice(index, 1);

                  // Update localStorage with the modified cartItems array
                  localStorage.setItem("cartItems", JSON.stringify(cartItems));

                  // Call the function to refresh the displayed cart items
                  displayCartItems();

                  // Update the cart count in the navbar
                  updateCartCount();

                  
                  if (window.location.pathname.includes('home.html')) {
                      // Retrieve the cartCount element from home.html and update its value
                      var cartCountElement = document.getElementById('cartCount');
                      if (cartCountElement) {
                          cartCountElement.innerText = totalCount;
                      }
                  }
                
              } else {
                  // Show an error message if the index is out of bounds
                  alertify.error('Invalid index for canceling item!');
              }
          }
    
        $(document).ready(function () {
            // Function to retrieve student information from localStorage
            function getStudentInfo() {
                var studentID = sessionStorage.getItem('studentID');
                var studentName = sessionStorage.getItem('studentName');
                return { studentID: studentID, studentName: studentName };
            }
        
            // Function to retrieve books from the cart stored in localStorage
            function getCartItems() {
                var cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
                return cartItems;
            }
        
            // Function to send borrow request to server
            function sendBorrowRequest(studentID, studentName, books) {
                // Prepare data to be sent in the request
                var requestData = {
                    studentID: studentID,
                    studentName: studentName,
                    books: books
                };
        
                $.ajax({
                    type: 'POST',
                    url: 'process/borrowProcess.php',
                    data: JSON.stringify(requestData),
                    contentType: 'application/json',
                    success: function (response) {
                        // Handle success response from server
                        console.log('Borrow request successful:', response);
                        // Clear cart after successful borrow
                        clearCart();
                        // Optionally, show a success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Books borrowed successfully!',
                            showConfirmButton: false,
                            timer: 2000 
                        });
                        setTimeout(function () {
                                    location.reload();
                        }, 2000);

                    },
                    error: function (xhr, status, error) {
                        // Handle error response from server
                        console.error('Error sending borrow request:', error);
                        // Optionally, show an error message
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed to borrow books',
                            text: 'An error occurred while processing your request. Please try again later.'
                        });
                    }
                });
            }
        
            // Function to clear the cart after borrowing
            function clearCart() {
                localStorage.removeItem('cartItems');
            }
        
            // Event listener for the borrow button click
            $('#borrowButton').click(function () {
                // Retrieve student information
                var studentInfo = getStudentInfo();
                var studentID = studentInfo.studentID;
                var studentName = studentInfo.studentName;
        
                // Retrieve books from the cart
                var books = getCartItems();
        
                // Check if there are books in the cart
                if (books.length === 0) {
                    // Optionally, show a message indicating that the cart is empty
                    Swal.fire({
                        icon: 'warning',
                        title: 'Empty Cart',
                        text: 'There are no books in your cart to borrow.'
                    });
                    return; // Exit function if cart is empty
                }
        
                // Send borrow request to server
                sendBorrowRequest(studentID, studentName, books);
            });
        });
        
    </script>
</body>
</html>